<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - F&B Anomaly Detection System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_v2.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-industry brand-icon"></i>
                <span class="brand-text">F&B Anomaly Detection</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="/dashboard" class="nav-link">Dashboard</a></li>
                <li class="nav-item"><a href="/reports" class="nav-link active">Reports</a></li>
                <li class="nav-item"><a href="#" class="nav-link" onclick="showHelp()">Help</a></li>
            </ul>
        </div>
    </nav>

    <!-- Reports Header -->
    <section class="reports-header">
        <div class="container">
            <h1>System Reports</h1>
            <p>Comprehensive analysis and insights from your F&B process monitoring</p>
        </div>
    </section>

    <!-- Report Cards -->
    <section class="reports-section">
        <div class="container">
            <div class="reports-grid">
                <!-- Data Quality Report -->
                <div class="report-card">
                    <div class="report-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3>Data Quality Report</h3>
                    <p>Analysis of data completeness, accuracy, and outlier detection</p>
                    <div class="report-metrics" id="quality-metrics">
                        <div class="metric">
                            <span class="metric-label">Data Score:</span>
                            <span class="metric-value" id="data-score">Loading...</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Outliers:</span>
                            <span class="metric-value" id="outliers-count">Loading...</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewQualityReport()">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                </div>

                <!-- Model Performance Report -->
                <div class="report-card">
                    <div class="report-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3>Model Performance</h3>
                    <p>Training results, accuracy metrics, and model validation</p>
                    <div class="report-metrics" id="model-metrics">
                        <div class="metric">
                            <span class="metric-label">Accuracy:</span>
                            <span class="metric-value" id="model-accuracy">Loading...</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Status:</span>
                            <span class="metric-value" id="model-status">Loading...</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewModelReport()">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                </div>

                <!-- Process Analytics -->
                <div class="report-card">
                    <div class="report-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <h3>Process Analytics</h3>
                    <p>Batch performance, quality trends, and process optimization</p>
                    <div class="report-metrics" id="process-metrics">
                        <div class="metric">
                            <span class="metric-label">Batches:</span>
                            <span class="metric-value" id="batch-count">Loading...</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Pass Rate:</span>
                            <span class="metric-value" id="pass-rate">Loading...</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewProcessReport()">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                </div>

                <!-- Anomaly Summary -->
                <div class="report-card">
                    <div class="report-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Anomaly Summary</h3>
                    <p>Alert history, anomaly patterns, and risk assessment</p>
                    <div class="report-metrics" id="anomaly-metrics">
                        <div class="metric">
                            <span class="metric-label">Alerts:</span>
                            <span class="metric-value" id="alerts-count">Loading...</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Risk Level:</span>
                            <span class="metric-value" id="risk-level">Loading...</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" onclick="viewAnomalyReport()">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Export Section -->
    <section class="export-section">
        <div class="container">
            <div class="export-panel">
                <div class="export-header">
            <h2>Export Reports</h2>
                    <p>Download comprehensive reports in various formats</p>
                </div>
            <div class="export-options">
                    <div class="export-option">
                        <div class="export-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="export-info">
                            <h3>Excel Report</h3>
                            <p>Detailed data analysis in Excel format</p>
                        </div>
                        <button class="btn btn-primary" onclick="exportExcel()">
                            <i class="fas fa-download"></i>
                            Export Excel
                </button>
                    </div>
                    <div class="export-option">
                        <div class="export-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="export-info">
                            <h3>PDF Report</h3>
                            <p>Formatted report with charts and analysis</p>
                        </div>
                        <button class="btn btn-primary" onclick="exportPDF()">
                            <i class="fas fa-download"></i>
                            Export PDF
                </button>
                    </div>
                    <div class="export-option">
                        <div class="export-icon">
                            <i class="fas fa-file-code"></i>
                        </div>
                        <div class="export-info">
                            <h3>JSON Data</h3>
                            <p>Raw data and metrics in JSON format</p>
                        </div>
                        <button class="btn btn-primary" onclick="exportJSON()">
                            <i class="fas fa-download"></i>
                            Export JSON
                </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal for detailed reports -->
    <div id="reportModal" class="modal">
        <div class="modal-content large">
            <span class="close" onclick="closeReportModal()">&times;</span>
            <h2 id="modal-title">Report Details</h2>
            <div id="modal-body">
                <div id="report-content">
                    <!-- Report content will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeReportModal()">Close</button>
                <button class="btn btn-primary" onclick="exportCurrentReport()">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loadingText">Loading reports...</p>
    </div>

    <script>
        let currentReport = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadReportMetrics();
        });

        async function loadReportMetrics() {
            showLoading('Loading report metrics...');
            
            try {
                // Load quality report
                const qualityResponse = await axios.get('/api/reports/quality');
                const qualityData = qualityResponse.data;
                
                if (qualityData.success) {
                    document.getElementById('data-score').textContent = 
                        qualityData.quality_report.overall_quality_score || 'N/A';
                    document.getElementById('outliers-count').textContent = 
                        qualityData.outlier_report.total_outliers || 0;
                }

                // Load training report
                const trainingResponse = await axios.get('/api/reports/training');
                const trainingData = trainingResponse.data;
                
                if (trainingData.success) {
                    const results = trainingData.training_status.results;
                    document.getElementById('model-accuracy').textContent = 
                        results ? `${(results.best_score * 100).toFixed(1)}%` : 'N/A';
                    document.getElementById('model-status').textContent = 
                        trainingData.training_status.completed ? 'Trained' : 'Not Trained';
                }

                // Load batch summary
                    const batchResponse = await axios.get('/api/batch-summary');
                    const batchData = batchResponse.data;
                    
                if (batchData.success) {
                    document.getElementById('batch-count').textContent = batchData.total_batches;
                    document.getElementById('pass-rate').textContent = `${batchData.pass_rate}%`;
                }

                // Load alerts
                    const alertsResponse = await axios.get('/api/alerts');
                const alertsData = alertsResponse.data;
                
                if (alertsData.success) {
                    document.getElementById('alerts-count').textContent = alertsData.total_alerts;
                    const riskLevel = alertsData.total_alerts > 10 ? 'High' : 
                                    alertsData.total_alerts > 5 ? 'Medium' : 'Low';
                    document.getElementById('risk-level').textContent = riskLevel;
                }

                hideLoading();

            } catch (error) {
                hideLoading();
                console.error('Error loading report metrics:', error);
                showModal('Error', 'Failed to load report metrics: ' + error.message);
            }
        }

        async function viewQualityReport() {
            showLoading('Loading quality report...');
            
            try {
                const response = await axios.get('/api/reports/quality');
                const data = response.data;

                if (data.success) {
                    const content = `
                        <div class="report-detail">
                            <h3>Data Quality Analysis</h3>
                            <div class="quality-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Overall Quality Score:</span>
                                    <span class="metric-value">${data.quality_report.overall_quality_score || 'N/A'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Missing Values Handled:</span>
                                    <span class="metric-value">${data.quality_report.missing_values_handled || 0}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Outliers Detected:</span>
                                    <span class="metric-value">${data.outlier_report.total_outliers || 0}</span>
                                </div>
                    </div>
                    </div>
                `;

                    showReportModal('Data Quality Report', content);
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to load quality report: ' + error.message);
            }
        }

        async function viewModelReport() {
            showLoading('Loading model report...');
            
            try {
                const response = await axios.get('/api/reports/training');
                const data = response.data;

                if (data.success) {
                    const results = data.training_status.results;
                    const content = `
                        <div class="report-detail">
                            <h3>Model Training Results</h3>
                            <div class="model-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Best Model:</span>
                                    <span class="metric-value">${results ? results.best_model : 'N/A'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Best Score (R²):</span>
                                    <span class="metric-value">${results ? results.best_score.toFixed(4) : 'N/A'}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Training Status:</span>
                                    <span class="metric-value">${data.training_status.completed ? 'Completed' : 'Not Completed'}</span>
                                </div>
                            </div>
                    </div>
                `;

                    showReportModal('Model Performance Report', content);
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to load model report: ' + error.message);
            }
        }

        async function viewProcessReport() {
            showLoading('Loading process report...');
            
            try {
                const response = await axios.get('/api/batch-summary');
                const data = response.data;

                if (data.success) {
                    const content = `
                        <div class="report-detail">
                            <h3>Process Analytics</h3>
                            <div class="process-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Total Batches:</span>
                                    <span class="metric-value">${data.total_batches}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Pass Rate:</span>
                                    <span class="metric-value">${data.pass_rate}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Average Quality:</span>
                                    <span class="metric-value">${calculateAverageQuality(data.batches)}%</span>
                                </div>
                    </div>
                    </div>
                `;

                    showReportModal('Process Analytics Report', content);
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to load process report: ' + error.message);
            }
        }

        async function viewAnomalyReport() {
            showLoading('Loading anomaly report...');
            
            try {
                const response = await axios.get('/api/alerts');
                const data = response.data;

                if (data.success) {
                    const content = `
                        <div class="report-detail">
                            <h3>Anomaly Summary</h3>
                            <div class="anomaly-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Total Alerts:</span>
                                    <span class="metric-value">${data.total_alerts}</span>
                    </div>
                                <div class="metric-row">
                                    <span class="metric-label">Risk Level:</span>
                                    <span class="metric-value">${data.total_alerts > 10 ? 'High' : data.total_alerts > 5 ? 'Medium' : 'Low'}</span>
                            </div>
                            </div>
                        </div>
                    `;
                    
                    showReportModal('Anomaly Summary Report', content);
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to load anomaly report: ' + error.message);
            }
        }

        function calculateAverageQuality(batches) {
            if (!batches || batches.length === 0) return 0;
            const total = batches.reduce((sum, batch) => sum + batch.actual_quality, 0);
            return (total / batches.length).toFixed(1);
        }

        function showReportModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('report-content').innerHTML = content;
            document.getElementById('reportModal').style.display = 'block';
            hideLoading();
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function exportExcel() {
            showModal('Export', 'Excel export functionality would be implemented here.');
        }

        function exportPDF() {
            showModal('Export', 'PDF export functionality would be implemented here.');
        }

        function exportJSON() {
            showModal('Export', 'JSON export functionality would be implemented here.');
        }

        function exportCurrentReport() {
            showModal('Export', 'Export current report functionality would be implemented here.');
        }

        function showModal(title, content) {
            alert(`${title}: ${content}`);
        }

        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showHelp() {
            showModal('Help', 
                'Reports Help\n\n' +
                '• Data Quality Report: Analysis of data completeness and accuracy\n' +
                '• Model Performance: Training results and accuracy metrics\n' +
                '• Process Analytics: Batch performance and quality trends\n' +
                '• Anomaly Summary: Alert history and risk assessment\n\n' +
                'Use the export options to download reports in various formats.'
            );
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
